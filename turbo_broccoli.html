<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>turbo_broccoli API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#turbobroccoli">TurboBroccoli ðŸ¥¦</a>
  <ul>
    <li><a href="#installation">Installation</a></li>
    <li><a href="#usage">Usage</a></li>
    <li><a href="#supported-types">Supported types</a></li>
    <li><a href="#environment-variables">Environment variables</a></li>
    <li><a href="#contributing">Contributing</a></li>
    <li><a href="#credits">Credits</a></li>
  </ul></li>
  <li><a href="#changelog">Changelog</a>
  <ul>
    <li><a href="#v400"><code>v4.0.0</code></a></li>
    <li><a href="#v210"><code>v2.1.0</code></a></li>
    <li><a href="#v200"><code>v2.0.0</code></a></li>
  </ul></li>
</ul>


            <h2>Submodules</h2>
            <ul>
                    <li><a href="turbo_broccoli/context.html">context</a></li>
                    <li><a href="turbo_broccoli/custom.html">custom</a></li>
                    <li><a href="turbo_broccoli/exceptions.html">exceptions</a></li>
                    <li><a href="turbo_broccoli/guard.html">guard</a></li>
                    <li><a href="turbo_broccoli/native.html">native</a></li>
                    <li><a href="turbo_broccoli/parallel.html">parallel</a></li>
                    <li><a href="turbo_broccoli/turbo_broccoli.html">turbo_broccoli</a></li>
                    <li><a href="turbo_broccoli/user.html">user</a></li>
            </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
turbo_broccoli    </h1>

                        <div class="docstring"><h1 id="turbobroccoli">TurboBroccoli ðŸ¥¦</h1>

<p><a href="https://github.com/altaris/turbo-broccoli"><img src="https://img.shields.io/badge/repo-github-pink" alt="Repository" /></a>
<a href="https://pypi.org/project/turbo-broccoli/"><img src="https://img.shields.io/pypi/v/turbo-broccoli" alt="PyPI" /></a>
<img src="https://img.shields.io/github/license/altaris/turbo-broccoli" alt="License" />
<a href="https://pypi.org/project/black"><img src="https://img.shields.io/badge/style-black-black" alt="Code
style" /></a>
<img src="https://img.shields.io/badge/project%20name%20by-github-pink" alt="hehe" />
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli.html"><img src="https://badgen.net/badge/documentation/here/green" alt="Documentation" /></a></p>

<p>JSON (de)serialization extensions, originally aimed at <code>numpy</code> and <code>tensorflow</code>
objects, but now supporting a wide range of objects.</p>

<h2 id="installation">Installation</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>turbo-broccoli
</code></pre>
</div>

<h2 id="usage">Usage</h2>

<h3 id="tofrom-string">To/from string</h3>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;an_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)}</span>
<span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</code></pre>
</div>

<p>produces the following string (modulo indentation and the value of
<code>$.an_array.data.data</code>):</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;an_array&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;numpy.ndarray&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;__version__&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bytes&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;__version__&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;QAAAAAAAAAB7ImRhd...&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>For deserialization, simply use</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">tb</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="tofrom-file">To/from file</h3>

<p>Simply replace
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#to_json"><code>turbo_broccoli.to_json</code></a>
and
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#from_json"><code>turbo_broccoli.from_json</code></a>
with
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#save_json"><code>turbo_broccoli.save_json</code></a>
and
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#load_json"><code>turbo_broccoli.load_json</code></a>:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;an_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)}</span>
<span class="n">tb</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;foo/bar/foobar.json&quot;</span><span class="p">)</span>

<span class="o">...</span>

<span class="n">obj</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="s2">&quot;foo/bar/foobar.json&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>It is also possible to read/write compressed (with
<a href="https://www.zlib.net/">zlib</a>) JSON files:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">tb</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;foo/bar/foobar.json.gz&quot;</span><span class="p">)</span>

<span class="o">...</span>

<span class="n">obj</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="s2">&quot;foo/bar/foobar.json.gz&quot;</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="contextshttpsaltarisgithubioturbo-broccoliturbo_broccolicontexthtmlcontext"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/context.html#Context">Contexts</a></h3>

<p>The behaviour of
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#to_json"><code>turbo_broccoli.to_json</code></a>
and
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#from_json"><code>turbo_broccoli.from_json</code></a>
can be tweaked by using
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/context.html#Context">contexts</a>.
For example, to set a encryption/decryption key for <a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/secret.html">secret
types</a>:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">nacl.secret</span>
<span class="kn">import</span> <span class="nn">nacl.utils</span>
<span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">nacl</span><span class="o">.</span><span class="n">secret</span><span class="o">.</span><span class="n">SecretBox</span><span class="o">.</span><span class="n">KEY_SIZE</span><span class="p">)</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">nacl_shared_key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">SecretStr</span><span class="p">(</span><span class="s2">&quot;dolphin&quot;</span><span class="p">)}</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>

<span class="o">...</span>

<span class="n">obj</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</code></pre>
</div>

<p>The behaviour of
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#save_json"><code>turbo_broccoli.save_json</code></a>
and
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#load_json"><code>turbo_broccoli.load_json</code></a>
can be tweaked in a similar manner. For convenience, the argument of the
context can be passed directly to the method instead of creating a context
object manually:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">nacl.secret</span>
<span class="kn">import</span> <span class="nn">nacl.utils</span>
<span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">nacl</span><span class="o">.</span><span class="n">secret</span><span class="o">.</span><span class="n">SecretBox</span><span class="o">.</span><span class="n">KEY_SIZE</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">SecretStr</span><span class="p">(</span><span class="s2">&quot;dolphin&quot;</span><span class="p">)}</span>
<span class="n">tb</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;foo/bar/foobar.json&quot;</span><span class="p">,</span> <span class="n">nacl_shared_key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</code></pre>
</div>

<p>See <a href="https://altaris.github.io/turbo_broccoli/context.html#Context">the
documentation</a>.</p>

<h3 id="guarded-blockshttpsaltarisgithubioturbo-broccoliturbo_broccoliguardhtml"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/guard.html">Guarded blocks</a></h3>

<p>A
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/guard.html#GuardedBlockHandler"><code>turbo_broccoli.GuardedBlockHandler</code></a>
"guards" a block of code, meaning it prevents it from being executed if it has
been in the past. Check out <a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/guard.html">the
documentation</a>
for some examples.</p>

<h3 id="guarded-parallel-executorshttpsaltarisgithubioturbo-broccoliturbo_broccoliparallelhtml"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/parallel.html">Guarded-parallel executors</a></h3>

<p>A mix of
<a href="https://joblib.readthedocs.io/en/latest/generated/joblib.Parallel.html"><code>joblib.Parallel</code></a>
and
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/guard.html#GuardedBlockHandler"><code>turbo_broccoli.GuardedBlockHandler</code></a>:
a
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/parallel.html#Parallel"><code>turbo_broccoli.Parallel</code></a>
object can be used to execute jobs in parallel, but those whose results have
already been obtained in the past are skipped. See <a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/parallel.html">the
documentation</a>
for some examples.</p>

<h3 id="custom-encodersdecoders">Custom encoders/decoders</h3>

<p>You can register you own custom encoders and decoders using
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/user.html#register_encoder"><code>turbo_broccoli.register_encoder</code></a>
and
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/user.html#register_decoder"><code>turbo_broccoli.register_decoder</code></a>:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="k">class</span> <span class="nc">MyClass</span><span class="p">:</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">encoder_c</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">MyClass</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="c1"># If you register a decoder, you must include the key &quot;__type__&quot; and it</span>
    <span class="c1"># must have value &quot;user.&lt;name_of_type&gt;&quot;</span>
    <span class="c1">#       â†“</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;__type__&quot;</span><span class="p">:</span> <span class="s2">&quot;user.MyClass&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">b</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">decoder_c</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyClass</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">MyClass</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">])</span>

<span class="n">tb</span><span class="o">.</span><span class="n">register_encoder</span><span class="p">(</span><span class="n">encoder_c</span><span class="p">,</span> <span class="s2">&quot;MyClass&quot;</span><span class="p">)</span>
<span class="n">tb</span><span class="o">.</span><span class="n">register_decoder</span><span class="p">(</span><span class="n">decoder_c</span><span class="p">,</span> <span class="s2">&quot;MyClass&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>An encoder (for <code>MyClass</code>) is a function that takes two arguments: an object of
type <code>MyClass</code> and a
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/context.html#Context"><code>turbo_broccoli.Context</code></a>,
and returns a <code>dict</code>. That dict must contain objects that can be further
serialized using TurboBroccoli (which includes all <a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli.html#supported-types">supported
types</a>
and any other type for which you registered an encoder). The return dict needs
not be flat.</p>

<p>If you register a decoder for <code>MyClass</code> (as in the example above), the dict
must contain the key/value <code>"__type__": "user.MyClass"</code>.</p>

<p>A decoder (for <code>MyClass</code>) is a function that takes two arguments: a dict and a
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/context.html#Context"><code>turbo_broccoli.Context</code></a>,
and returns an object of type <code>MyClass</code>. The dict's values have already been
deserialized.</p>

<h3 id="artifacts">Artifacts</h3>

<p>If an object inside <code>obj</code> is too large to be embedded inside the JSON file
(e.g. a large numpy array), then an <em>artifact</em> file is created:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;an_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)}</span>
<span class="n">tb</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;foo/bar/foobar.json&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>produces the JSON file</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;an_array&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;numpy.ndarray&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;__version__&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bytes&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;__version__&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1e6dff28-5e26-44df-9e7a-75bc726ce9aa&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>and a file <code>foo/bar/foobar.1e6dff28-5e26-44df-9e7a-75bc726ce9aa.tb</code> containing
the array data. The artifact directory can be explicitely specified by setting
it in the <a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/context.html#Context">serialization
context</a>
or by setting the <code>TB_ARTIFACT_PATH</code> environment variable (see below.). The
code for loading the JSON file does not change:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">obj</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="s2">&quot;foo/bar/foobar.json&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>If using
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#to_json"><code>turbo_broccoli.to_json</code></a>,
since there is no output file path specified, the artifacts are storied in a
temporary directory instead:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;an_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)}</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="c1"># An artifact has been created somewhere in e.g. /tmp</span>
</code></pre>
</div>

<p>Since no information about this directory is stored in the output JSON string,
it is not possible to load <code>doc</code> using
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/turbo_broccoli.html#load_json"><code>turbo_broccoli.from_json</code></a>.
If deserialization is necessary, instantiate a <a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/context.html#Context">context</a>:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;an_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)}</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
<span class="c1"># An artifact has been created in ctx.artifact_path</span>

<span class="o">...</span>

<span class="n">obj</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="supported-types">Supported types</h2>

<h3 id="basic-types">Basic types</h3>

<ul>
<li><p><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/bytes.html#to_json"><code>bytes</code></a></p></li>
<li><p><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/collections.html#to_json">Collections</a>:
<code>collections.deque</code>, <code>collections.namedtuple</code></p></li>
<li><p><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/dataclass.html#to_json">Dataclasses</a>:
serialization is straightforward:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
  <span class="n">a</span><span class="p">:</span> <span class="nb">int</span>
  <span class="n">b</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">({</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="s2">&quot;Hello&quot;</span><span class="p">)})</span>
</code></pre>
</div>

<p>For deserialization, first register the class:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">ctx</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">dataclass_types</span><span class="o">=</span><span class="p">[</span><span class="n">C</span><span class="p">])</span>
<span class="n">tb</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</code></pre>
</div></li>
<li><p><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/datetime.html#to_json"><code>datetime.datetime</code>, <code>datetime.time</code>,
<code>datetime.timedelta</code></a></p></li>
<li><p>Non JSON-able dicts, i.e. dicts whose keys are not all <code>str</code>, <code>int</code>, <code>float</code>,
<code>bool</code> or <code>None</code></p></li>
<li><p><a href="https://docs.python.org/3/library/uuid.html">UUID objects</a></p></li>
<li><p><a href="https://docs.python.org/3/library/pathlib.html#pathlib.Path"><code>pathlib.Path</code></a></p></li>
</ul>

<h3 id="generic-objects">Generic objects</h3>

<p><strong>Serialization only</strong>. A generic object is an object that
has the <code>__turbo_broccoli__</code> attribute. This attribute is expected to be a list
of attributes whose values will be serialized. For example,</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
    <span class="n">__turbo_broccoli__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">c</span><span class="p">:</span> <span class="nb">int</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
<span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span>
<span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre>
</div>

<p>produces the following string:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span><span class="nt">&quot;a&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="nt">&quot;b&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">43</span><span class="p">}</span>
</code></pre>
</div>

<p>Registered attributes can of course have any type supported by TurboBroccoli,
such as numpy arrays. Registered attributes can be <code>@property</code> methods.</p>

<h3 id="kerashttpsaltarisgithubioturbo-broccoliturbo_broccolicustomkerashtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/keras.html#to_json">Keras</a></h3>

<ul>
<li><p><a href="https://keras.io/api/models/model/"><code>keras.Model</code></a>;</p></li>
<li><p>standard subclasses of <a href="https://keras.io/api/layers/"><code>keras.layers.Layer</code></a>,
<a href="https://keras.io/api/losses/"><code>keras.losses.Loss</code></a>,
<a href="https://keras.io/api/metrics/"><code>keras.metrics.Metric</code></a>, and
<a href="https://keras.io/api/optimizers/"><code>keras.optimizers.Optimizer</code></a>.</p></li>
</ul>

<h3 id="numpyhttpsaltarisgithubioturbo-broccoliturbo_broccolicustomnumpyhtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/numpy.html#to_json">Numpy</a></h3>

<p><code>numpy.number</code>, <code>numpy.ndarray</code> with numerical dtype, and <code>numpy.dtype</code>.</p>

<h3 id="pandashttpsaltarisgithubioturbo-broccoliturbo_broccolicustompandashtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/pandas.html#to_json">Pandas</a></h3>

<p><code>pandas.DataFrame</code> and <code>pandas.Series</code>, but with the following limitations:</p>

<ul>
<li><p>the following dtypes are not supported: <code>complex</code>, <code>object</code>, <code>timedelta</code>;</p></li>
<li><p>the column / series names cannot be ints or int-strings: the following are
not acceptable</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">])</span>
</code></pre>
</div></li>
</ul>

<h3 id="tensorflowhttpsaltarisgithubioturbo-broccoliturbo_broccolicustomtensorflowhtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/tensorflow.html#to_json">Tensorflow</a></h3>

<p><code>tensorflow.Tensor</code> with numerical dtype, but not <code>tensorflow.RaggedTensor</code>.</p>

<h3 id="pytorchhttpsaltarisgithubioturbo-broccoliturbo_broccolicustompytorchhtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/pytorch.html#to_json">Pytorch</a></h3>

<ul>
<li><p><code>torch.Tensor</code>, <strong>Warning</strong>: loaded tensors are automatically placed on the
CPU and gradients are lost;</p></li>
<li><p><code>torch.nn.Module</code>, don't forget to register your module type using a
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/context.html#Context"><code>turbo_broccoli.Context</code></a>:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># Serialization</span>
<span class="k">class</span> <span class="nc">MyModule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="o">...</span>

<span class="n">module</span> <span class="o">=</span> <span class="n">MyModule</span><span class="p">()</span>  <span class="c1"># Must be instantiable without arguments</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">({</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">module</span><span class="p">})</span>

<span class="c1"># Deserialization</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">pytorch_module_types</span><span class="o">=</span><span class="p">[</span><span class="n">MyModule</span><span class="p">])</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</code></pre>
</div>

<p><strong>Warning</strong>: It is not possible to register and deserialize <a href="https://pytorch.org/docs/stable/nn.html#containers">standard pytorch
module containers</a>
directly. Wrap them in your own custom module class. For following is not
acceptable</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">module</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
  <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
  <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
  <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">module</span><span class="p">}</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># works, but...</span>
<span class="n">tb</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>  <span class="c1"># does&#39;t work</span>
</code></pre>
</div>

<p>but the following works:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">class</span> <span class="nc">MyModule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="n">module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span>  <span class="c1"># Wrapped sequential</span>

<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
    <span class="p">)</span>

<span class="o">...</span>

<span class="n">module</span> <span class="o">=</span> <span class="n">MyModule</span><span class="p">()</span>  <span class="c1"># Must be instantiable without arguments</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">({</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">module</span><span class="p">})</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">pytorch_module_types</span><span class="o">=</span><span class="p">[</span><span class="n">MyModule</span><span class="p">])</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</code></pre>
</div>

<p>To circumvent all these limitations, use custom encoders / decoders.</p></li>
<li><p><code>torch.utils.data.ConcatDataset</code>, <code>torch.utils.data.StackDataset</code>,
<code>torch.utils.data.Subset</code>, <code>torch.utils.data.TensorDataset</code>, as long as the
nested structure of datasets ultimately lead to
<code>torch.utils.data.TensorDataset</code>s (e.g. a subset of a stack of subsets of
tensor datasets is supported)</p></li>
</ul>

<h3 id="scipyhttpsaltarisgithubioturbo-broccoliturbo_broccolicustomscipyhtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/scipy.html#to_json">Scipy</a></h3>

<p>Just <code>scipy.sparse.csr_matrix</code>. ^^"</p>

<h3 id="scikit-learnhttpsaltarisgithubioturbo-broccoliturbo_broccolicustomsklearnhtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/sklearn.html#to_json">Scikit-learn</a></h3>

<p><code>sklearn</code> estimators (i.e. that inherit from
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.BaseEstimator.html"><code>sklean.base.BaseEstimator</code></a>).
Supported estimators are: <code>AdaBoostClassifier</code>, <code>AdaBoostRegressor</code>,
<code>AdditiveChi2Sampler</code>, <code>AffinityPropagation</code>, <code>AgglomerativeClustering</code>,
<code>ARDRegression</code>, <code>BayesianGaussianMixture</code>, <code>BayesianRidge</code>, <code>BernoulliNB</code>,
<code>BernoulliRBM</code>, <code>Binarizer</code>, <code>CategoricalNB</code>, <code>CCA</code>, <code>ClassifierChain</code>,
<code>ComplementNB</code>, <code>DBSCAN</code>, <code>DecisionTreeClassifier</code>, <code>DecisionTreeRegressor</code>,
<code>DictionaryLearning</code>, <code>ElasticNet</code>, <code>EllipticEnvelope</code>, <code>EmpiricalCovariance</code>,
<code>ExtraTreeClassifier</code>, <code>ExtraTreeRegressor</code>, <code>ExtraTreesClassifier</code>,
<code>ExtraTreesRegressor</code>, <code>FactorAnalysis</code>, <code>FeatureUnion</code>, <code>GaussianMixture</code>,
<code>GaussianNB</code>, <code>GaussianRandomProjection</code>, <code>GraphicalLasso</code>, <code>HuberRegressor</code>,
<code>IncrementalPCA</code>, <code>IsolationForest</code>, <code>Isomap</code>, <code>KernelCenterer</code>,
<code>KernelDensity</code>, <code>KernelPCA</code>, <code>KernelRidge</code>, <code>KMeans</code>, <code>KNeighborsClassifier</code>,
<code>KNeighborsRegressor</code>, <code>KNNImputer</code>, <code>LabelBinarizer</code>, <code>LabelEncoder</code>,
<code>LabelPropagation</code>, <code>LabelSpreading</code>, <code>Lars</code>, <code>Lasso</code>, <code>LassoLars</code>,
<code>LassoLarsIC</code>, <code>LatentDirichletAllocation</code>, <code>LedoitWolf</code>,
<code>LinearDiscriminantAnalysis</code>, <code>LinearRegression</code>, <code>LinearSVC</code>, <code>LinearSVR</code>,
<code>LocallyLinearEmbedding</code>, <code>LocalOutlierFactor</code>, <code>LogisticRegression</code>,
<code>MaxAbsScaler</code>, <code>MDS</code>, <code>MeanShift</code>, <code>MinCovDet</code>, <code>MiniBatchDictionaryLearning</code>,
<code>MiniBatchKMeans</code>, <code>MiniBatchSparsePCA</code>, <code>MinMaxScaler</code>, <code>MissingIndicator</code>,
<code>MLPClassifier</code>, <code>MLPRegressor</code>, <code>MultiLabelBinarizer</code>, <code>MultinomialNB</code>,
<code>MultiOutputClassifier</code>, <code>MultiOutputRegressor</code>, <code>MultiTaskElasticNet</code>,
<code>MultiTaskLasso</code>, <code>NearestCentroid</code>, <code>NearestNeighbors</code>,
<code>NeighborhoodComponentsAnalysis</code>, <code>NMF</code>, <code>Normalizer</code>, <code>NuSVC</code>, <code>NuSVR</code>,
<code>Nystroem</code>, <code>OAS</code>, <code>OneClassSVM</code>, <code>OneVsOneClassifier</code>, <code>OneVsRestClassifier</code>,
<code>OPTICS</code>, <code>OrthogonalMatchingPursuit</code>, <code>PassiveAggressiveRegressor</code>, <code>PCA</code>,
<code>Pipeline</code>, <code>PLSCanonical</code>, <code>PLSRegression</code>, <code>PLSSVD</code>, <code>PolynomialCountSketch</code>,
<code>PolynomialFeatures</code>, <code>PowerTransformer</code>, <code>QuadraticDiscriminantAnalysis</code>,
<code>QuantileRegressor</code>, <code>QuantileTransformer</code>, <code>RadiusNeighborsClassifier</code>,
<code>RadiusNeighborsRegressor</code>, <code>RandomForestClassifier</code>, <code>RandomForestRegressor</code>,
<code>RANSACRegressor</code>, <code>RBFSampler</code>, <code>RegressorChain</code>, <code>RFE</code>, <code>RFECV</code>, <code>Ridge</code>,
<code>RidgeClassifier</code>, <code>RobustScaler</code>, <code>SelectFromModel</code>, <code>SelfTrainingClassifier</code>,
<code>SGDRegressor</code>, <code>ShrunkCovariance</code>, <code>SimpleImputer</code>, <code>SkewedChi2Sampler</code>,
<code>SparsePCA</code>, <code>SparseRandomProjection</code>, <code>SpectralBiclustering</code>,
<code>SpectralClustering</code>, <code>SpectralCoclustering</code>, <code>SpectralEmbedding</code>,
<code>StackingClassifier</code>, <code>StackingRegressor</code>, <code>StandardScaler</code>, <code>SVC</code>, <code>SVC</code>,
<code>SVR</code>, <code>SVR</code>, <code>TheilSenRegressor</code>, <code>TruncatedSVD</code>, <code>TSNE</code>, <code>VarianceThreshold</code>,
<code>VotingClassifier</code>, <code>VotingRegressor</code>.</p>

<p>Doesn't work with:</p>

<ul>
<li><p>All CV classes because the <code>score_</code> attribute is a dict indexed with
<code>np.int64</code>, which <code>json.JSONEncoder._iterencode_dict</code> rejects.</p></li>
<li><p>Everything that is parametrized by an arbitrary object/callable/estimator:
<code>FunctionTransformer</code>, <code>TransformedTargetRegressor</code>.</p></li>
<li><p>Other classes that have non JSON-serializable attributes:</p>

<table>
<thead>
<tr>
  <th>Class</th>
  <th>Non-serializable attr.</th>
</tr>
</thead>
<tbody>
<tr>
  <td><code>Birch</code></td>
  <td><code>_CFNode</code></td>
</tr>
<tr>
  <td><code>BisectingKMeans</code></td>
  <td><code>function</code></td>
</tr>
<tr>
  <td><code>ColumnTransformer</code></td>
  <td><code>slice</code></td>
</tr>
<tr>
  <td><code>GammaRegressor</code></td>
  <td><code>HalfGammaLoss</code></td>
</tr>
<tr>
  <td><code>GaussianProcessClassifier</code></td>
  <td><code>Product</code></td>
</tr>
<tr>
  <td><code>GaussianProcessRegressor</code></td>
  <td><code>Sum</code></td>
</tr>
<tr>
  <td><code>IsotonicRegression</code></td>
  <td><code>interp1d</code></td>
</tr>
<tr>
  <td><code>OutputCodeClassifier</code></td>
  <td><code>_ConstantPredictor</code></td>
</tr>
<tr>
  <td><code>Perceptron</code></td>
  <td><code>Hinge</code></td>
</tr>
<tr>
  <td><code>PoissonRegressor</code></td>
  <td><code>HalfPoissonLoss</code></td>
</tr>
<tr>
  <td><code>SGDClassifier</code></td>
  <td><code>Hinge</code></td>
</tr>
<tr>
  <td><code>SGDOneClassSVM</code></td>
  <td><code>Hinge</code></td>
</tr>
<tr>
  <td><code>SplineTransformer</code></td>
  <td><code>BSpline</code></td>
</tr>
<tr>
  <td><code>TweedieRegressor</code></td>
  <td><code>HalfTweedieLossIdentity</code></td>
</tr>
</tbody>
</table></li>
<li><p>Other errors:</p>

<ul>
<li><p><code>FastICA</code>: I'm not sure why...</p></li>
<li><p><code>BaggingClassifier</code>: <code>IndexError: only integers, slices (:), ellipsis
(...), numpy.newaxis (None) and integer or boolean arrays are valid
indices</code>.</p></li>
<li><p><code>GradientBoostingClassifier</code>, <code>GradientBoostingRegressor</code>,
<code>RandomTreesEmbedding</code>, <code>KBinsDiscretizer</code>: <code>Exception:
dtype object is not covered</code>.</p></li>
<li><p><code>HistGradientBoostingClassifier</code>: Problems with deserialization of
<code>_BinMapper</code> object?</p></li>
<li><p><code>PassiveAggressiveClassifier</code>: some unknown label type error...</p></li>
<li><p><code>SequentialFeatureSelector</code>: Problem with the unit test itself ^^"</p></li>
<li><p><code>KNeighborsTransformer</code>: A serialized-deserialized instance seems to
<code>fit_transform</code> an array to a sparse matrix whereas the original object
returns an array?</p></li>
<li><p><code>RadiusNeighborsTransformer</code>: Inverse problem from <code>KNeighborsTransformer</code>.</p></li>
</ul></li>
</ul>

<h3 id="bokehhttpsaltarisgithubioturbo-broccoliturbo_broccolicustombokehhtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/bokeh.html#to_json">Bokeh</a></h3>

<p>Bokeh <a href="https://docs.bokeh.org/en/latest">figures</a> and
<a href="https://docs.bokeh.org/en/latest/docs/reference/models.html">models</a>.</p>

<h3 id="networkxhttpsaltarisgithubioturbo-broccoliturbo_broccolicustomnetworkxhtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/networkx.html#to_json">NetworkX</a></h3>

<p>All NetworkX <a href="https://networkx.org/documentation/stable/reference/classes/index.html#which-graph-class-should-i-use">graph
objects</a>.</p>

<h3 id="secretshttpsaltarisgithubioturbo-broccoliturbo_broccolicustomsecrethtmlto_json"><a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/secret.html#to_json">Secrets</a></h3>

<p>Basic Python types can be wrapped in their corresponding secret type according
to the following table</p>

<table>
<thead>
<tr>
  <th>Python type</th>
  <th>Secret type</th>
</tr>
</thead>
<tbody>
<tr>
  <td><code>dict</code></td>
  <td><code>turbo_broccoli.SecretDict</code></td>
</tr>
<tr>
  <td><code>float</code></td>
  <td><code>turbo_broccoli.SecretFloat</code></td>
</tr>
<tr>
  <td><code>int</code></td>
  <td><code>turbo_broccoli.SecretInt</code></td>
</tr>
<tr>
  <td><code>list</code></td>
  <td><code>turbo_broccoli.SecretList</code></td>
</tr>
<tr>
  <td><code>str</code></td>
  <td><code>turbo_broccoli.SecretStr</code></td>
</tr>
</tbody>
</table>

<p>The secret value can be recovered with the <code>get_secret_value</code> method. At
serialization, the this value will be encrypted. For example,</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1">## See https://pynacl.readthedocs.io/en/latest/secret/#key</span>
<span class="kn">import</span> <span class="nn">nacl.secret</span>
<span class="kn">import</span> <span class="nn">nacl.utils</span>
<span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">nacl</span><span class="o">.</span><span class="n">secret</span><span class="o">.</span><span class="n">SecretBox</span><span class="o">.</span><span class="n">KEY_SIZE</span><span class="p">)</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">nacl_shared_key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">SecretStr</span><span class="p">(</span><span class="s2">&quot;dolphin&quot;</span><span class="p">)}</span>
<span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</code></pre>
</div>

<p>produces the following string (modulo indentation and modulo the encrypted
content):</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;secret&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;__version__&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bytes&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;__version__&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gbRXF3hq9Q9hIQ9Xz+WdGKYP5meJ4eTmlFt0r0Ov3PV64065plk6RqsFUcynSOqHzA==&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Deserialization decrypts the secrets, but they stay wrapped inside the secret
types above. If the wrong key is provided, an exception is raised. If no key is
provided, the secret values are replaced by a
<code>turbo_broccoli.LockedSecret</code>. Internally, TurboBroccoli uses
<a href="https://pynacl.readthedocs.io/en/latest/"><code>pynacl</code></a>'s
<a href="https://pynacl.readthedocs.io/en/latest/secret/#nacl.secret.SecretBox"><code>SecretBox</code></a>.
<strong>Warning</strong>: In the case of <code>SecretDict</code> and <code>SecretList</code>, the values contained
within must be JSON-serializable <strong>without</strong> TurboBroccoli. The following is
not acceptable:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">nacl.secret</span>
<span class="kn">import</span> <span class="nn">nacl.utils</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">nacl</span><span class="o">.</span><span class="n">secret</span><span class="o">.</span><span class="n">SecretBox</span><span class="o">.</span><span class="n">KEY_SIZE</span><span class="p">)</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">nacl_shared_key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">SecretList</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])])}</span>
<span class="n">tb</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</code></pre>
</div>

<p>See also the <code>TB_SHARED_KEY</code> environment variable below.</p>

<h3 id="embedded-dictlists">Embedded dict/lists</h3>

<p>Sometimes, it may be useful to store part of a document in its own file and
have referrenced in the main file. This is possible using
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/embedded.html"><code>EmbeddedDict</code></a>
and
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/embedded.html"><code>EmbeddedList</code></a>.
For example,</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span> <span class="nn">turbo_broccoli</span> <span class="kn">import</span> <span class="n">save_json</span><span class="p">,</span> <span class="n">EmbeddedDict</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">EmbeddedDict</span><span class="p">({</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})}</span>
<span class="n">save_json</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;data.json&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>will result in a <code>data.json</code> file containing</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;a&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;b&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;embedded.dict&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;__version__&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4ea0b3f3-f3e4-42bd-9db9-1e4e0b9f4fae&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>(modulo indentation and the id), and an artefact file
<code>data.4ea0b3f3-f3e4-42bd-9db9-1e4e0b9f4fae.json</code> containing</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span><span class="nt">&quot;c&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">}</span>
</code></pre>
</div>

<h3 id="external-data">Â External data</h3>

<p>If you are serializing/deserializing from a file, you can use
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/custom/external.html"><code>turbo_broccoli.ExternalData</code></a>
to point to data contained in another file without integrating it to the
current document.</p>

<p>For example, let's say you want to create <code>foo/bar.json</code> where the <code>a</code> key
points to the data contained in <code>foo/foooooo/data.np</code>:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">turbo_broccoli</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="n">document</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">ExternalData</span><span class="p">(</span><span class="s2">&quot;foooooo/data.np&quot;</span><span class="p">),</span>
  <span class="o">...</span>
<span class="p">}</span>

<span class="c1"># data.np is loaded when creating the ExternalData object</span>
<span class="nb">print</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Saving</span>
<span class="n">tb</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;foo/bar.json&quot;</span><span class="p">)</span>

<span class="c1"># Loading</span>
<span class="n">document2</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="s2">&quot;foo/bar.json&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_array_equal</span>
<span class="n">assert_array_equal</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">document2</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre>
</div>

<p>Warnings:</p>

<ul>
<li><p><code>document["a"].data</code> is read only, the following will have no effect on
<code>foo/foooooo/data.np</code>:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">document</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">tb</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;foo/bar.json&quot;</span><span class="p">)</span>
</code></pre>
</div></li>
<li><p>When serializing/deserializing a <code>ExternalData</code> object, an actual JSON
document must be involved. In particular, using <code>tb.to_json</code> or
<code>tb.from_json</code> is not possible.</p></li>
<li><p>The external data file's path must be a subpath of the output/intput JSON
file, and provided either relative to the output/intput JSON file, or in
absolute form:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># OK, relative</span>
<span class="n">document</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">ExternalData</span><span class="p">(</span><span class="s2">&quot;foooooo/data.np&quot;</span><span class="p">)}</span>
<span class="n">tb</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;foo/bar.json&quot;</span><span class="p">)</span>

<span class="c1"># OK, absolute</span>
<span class="n">document</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">ExternalData</span><span class="p">(</span><span class="s2">&quot;/home/alice/foo/foooooo/data.np&quot;</span><span class="p">)}</span>
<span class="n">tb</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;foo/bar.json&quot;</span><span class="p">)</span>

<span class="c1"># ERROR, not subpath</span>
<span class="n">document</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">ExternalData</span><span class="p">(</span><span class="s2">&quot;/home/alice/data.np&quot;</span><span class="p">)}</span>
<span class="n">tb</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;/home/alice/foo/bar.json&quot;</span><span class="p">)</span>
</code></pre>
</div></li>
</ul>

<h2 id="environment-variables">Environment variables</h2>

<p>Some behaviors of TurboBroccoli can be tweaked by setting specific environment
variables. If you want to modify these parameters programatically, do not do so
by modifying <code>os.environ</code>. Rather, use a
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli/context.html#Context"><code>turbo_broccoli.Context</code></a>.</p>

<ul>
<li><p><code>TB_ARTIFACT_PATH</code> (default: output JSON file's parent directory): During
serialization, TurboBroccoli may create artifacts to which the JSON object
will point to. The artifacts will be stored in <code>TB_ARTIFACT_PATH</code> if
specified.</p></li>
<li><p><code>TB_KERAS_FORMAT</code> (default: <code>tf</code>, valid values are <code>keras</code>, <code>tf</code>, and <code>h5</code>):
The serialization format for keras models. If <code>h5</code> or <code>tf</code> is used, an
artifact following said format will be created in <code>TB_ARTIFACT_PATH</code>. If
<code>json</code> is used, the model will be contained in the JSON document (anthough
the weights may be in artifacts if they are too large).</p></li>
<li><p><code>TB_MAX_NBYTES</code> (default: <code>8000</code>):
The maximum byte size of a python object beyond which serialization will
produce an artifact instead of storing it in the JSON document. This does not
limit the size of the overall JSON document though. 8000 bytes should be
enough for a numpy array of 1000 <code>float64</code>s to be stored in-document.</p></li>
<li><p><code>TB_NODECODE</code> (default: empty):
Comma-separated list of types to not deserialize, for example
<code>bytes,numpy.ndarray</code>. Excludable types are:</p>

<ul>
<li><p><code>bokeh</code>, <code>bokeh.buffer</code>, <code>bokeh.generic</code>,</p></li>
<li><p><code>bytes</code>, <strong>Warning</strong> excluding <code>bytes</code> will also exclude <code>bokeh</code>,
<code>numpy.ndarray</code>, <code>pytorch.module</code>, <code>pytorch.tensor</code>, <code>secret</code>,
<code>tensorflow.tensor</code>,</p></li>
<li><p><code>collections</code>, <code>collections.deque</code>, <code>collections.namedtuple</code>,
<code>collections.set</code>,</p></li>
<li><p><code>dataclass</code>, <code>dataclass.&lt;dataclass_name&gt;</code> (case sensitive),</p></li>
<li><p><code>datetime</code>, <code>datetime.datetime</code>, <code>datetime.time</code>, <code>datetime.timedelta</code>,</p></li>
<li><p><code>dict</code> (this only prevents decoding dicts with non-string keys),</p></li>
<li><p><code>embedded</code>, <code>embedded.dict</code>, <code>embedded.list</code>,</p></li>
<li><p><code>external</code>,</p></li>
<li><p><code>generic</code>,</p></li>
<li><p><code>keras</code>, <code>keras.model</code>, <code>keras.layer</code>, <code>keras.loss</code>, <code>keras.metric</code>,
<code>keras.optimizer</code>,</p></li>
<li><p><code>networkx</code>, <code>networkx.graph</code>,</p></li>
<li><p><code>numpy</code>, <code>numpy.ndarray</code>, <code>numpy.number</code>, <code>numpy.dtype</code>,
<code>numpy.random_state</code>,</p></li>
<li><p><code>pandas</code>, <code>pandas.dataframe</code>, <code>pandas.series</code>, <strong>Warning</strong>: excluding
<code>pandas.dataframe</code> will also exclude <code>pandas.series</code>,</p></li>
<li><p><code>pathlib</code>, <code>pathlib.path</code>, <strong>Warning</strong>: excluding <code>pathlib.path</code> will also
exclude <code>external</code>,</p></li>
<li><p><code>pytorch</code>, <code>pytorch.tensor</code>, <code>pytorch.module</code>, <code>pytorch.concatdataset</code>,
<code>pytorch.stackdataset</code>, <code>pytorch.subset</code>, <code>pytorch.tensordataset</code></p></li>
<li><p><code>scipy</code>, <code>scipy.csr_matrix</code>,</p></li>
<li><p><code>secret</code>,</p></li>
<li><p><code>sklearn</code>, <code>sklearn.estimator</code>, <code>sklearn.estimator.&lt;estimator name&gt;</code> (case
sensitive, see the list of supported sklearn estimators below),</p></li>
<li><p><code>tensorflow</code>, <code>tensorflow.sparse_tensor</code>, <code>tensorflow.tensor</code>,
<code>tensorflow.variable</code>.</p></li>
<li><p><code>uuid</code></p></li>
<li><p><code>external</code></p></li>
</ul></li>
<li><p><code>TB_SHARED_KEY</code> (default: empty):
Secret key used to encrypt/decrypt secrets. The encryption uses <a href="https://pynacl.readthedocs.io/en/latest/secret/#nacl.secret.SecretBox"><code>pynacl</code>'s
<code>SecretBox</code></a>.
An exception is raised when attempting to serialize a secret type while no
key is set.</p></li>
</ul>

<h2 id="contributing">Contributing</h2>

<h3 id="dependencies">Dependencies</h3>

<ul>
<li><p><code>python3.10</code> or newer;</p></li>
<li><p><code>requirements.txt</code> for runtime dependencies;</p></li>
<li><p><code>requirements.dev.txt</code> for development dependencies.</p></li>
<li><p><code>make</code> (optional);</p></li>
</ul>

<p>Simply run</p>

<div class="pdoc-code codehilite">
<pre><span></span><code>virtualenv<span class="w"> </span>venv<span class="w"> </span>-p<span class="w"> </span>python3.10
.<span class="w"> </span>./venv/bin/activate
pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip
pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.dev.txt
</code></pre>
</div>

<h3 id="documentation">Documentation</h3>

<p>Simply run</p>

<div class="pdoc-code codehilite">
<pre><span></span><code>make<span class="w"> </span>docs
</code></pre>
</div>

<p>This will generate the HTML doc of the project, and the index file should be at
<code>docs/index.html</code>. To have it directly in your browser, run</p>

<div class="pdoc-code codehilite">
<pre><span></span><code>make<span class="w"> </span>docs-browser
</code></pre>
</div>

<h3 id="code-quality">Code quality</h3>

<p>Don't forget to run</p>

<div class="pdoc-code codehilite">
<pre><span></span><code>make
</code></pre>
</div>

<p>to format the code following <a href="https://pypi.org/project/black/">black</a>,
typecheck it using <a href="http://mypy-lang.org/">mypy</a>, and check it against coding
standards using <a href="https://pylint.org/">pylint</a>.</p>

<h3 id="unit-tests">Unit tests</h3>

<p>Run</p>

<div class="pdoc-code codehilite">
<pre><span></span><code>make<span class="w"> </span><span class="nb">test</span>
</code></pre>
</div>

<p>to have <a href="https://docs.pytest.org/">pytest</a> run the unit tests in <code>tests/</code>.</p>

<h2 id="credits">Credits</h2>

<p>This project takes inspiration from
<a href="https://github.com/Crimson-Crow/json-numpy">Crimson-Crow/json-numpy</a>.</p>

<h1 id="changelog">Changelog</h1>

<h2 id="v400"><code>v4.0.0</code></h2>

<ul>
<li><p><code>safetensors</code> is not required for (de)serializing <code>numpy.ndarray</code>,
<code>torch.Tensor</code>, and <code>tensorflow.Tensor</code>.</p></li>
<li><p>Before <code>v4</code>, JSON document looked like</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;__TYPE__&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>and</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;__TYPE__&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SUBTYPE&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>now they look like</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TYPE&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="err">...</span>
<span class="p">}</span>
</code></pre>
</div>

<p>and</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;__type__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TYPE.SUBTYPE&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="err">...</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This declutters the overall structure of the JSON documents.</p></li>
<li><p>Introduction of (de)serialization context objects
(<code><a href="turbo_broccoli/context.html#Context">turbo_broccoli.context.Context</a></code>), which contain various information and
parameters about the ongoing (de)serialization operation. You can use it when
calling <code>turbo_broccoli.from_json</code> or <code>turbo_broccoli.to_json</code>. For
convenience, <code>turbo_broccoli.save_json</code> and <code>turbo_broccoli.load_json</code> take
the context parameter's as kwargs.</p></li>
<li><p>Removal of <code>turbo_broccoli.environment</code>. Use <code><a href="turbo_broccoli/context.html#Context">turbo_broccoli.context.Context</a></code>
instead.</p></li>
<li><p>Sentinel booleans like <code>HAS_NUMPY</code>, <code>HAS_PANDA</code> etc. are now in
<code><a href="turbo_broccoli/custom.html">turbo_broccoli.custom</a></code>.</p></li>
<li><p>Deleted <code>turbo_broccoli.guard.guarded_call</code> and
<code>turbo_broccoli.guard.produces_document</code>. The iterable version of
<code><a href="turbo_broccoli/guard.html#GuardedBlockHandler.guard">turbo_broccoli.guard.GuardedBlockHandler.guard</a></code> no longer exist.</p></li>
<li><p>Removal of the CLI.</p></li>
<li><p>With a <code><a href="turbo_broccoli/guard.html#GuardedBlockHandler">turbo_broccoli.guard.GuardedBlockHandler</a></code>, it is now possible to not
load the block's results if the block is skipped. See the class
documentation.</p></li>
<li><p>Artifacts not have the output JSON filename's stem as a prefix and the <code>.tb</code>
extension. For example, if the output file is <code>test.json</code>, then an artifact
filename would be <code>test.&lt;UUID4&gt;.tb</code>. If no output filename is set in the
serialization context, then artifact filenames simply have the form
<code>&lt;UUID4&gt;.tb</code>.</p></li>
<li><p><code>turbo_broccoli.utils</code> has been renamed to <code><a href="turbo_broccoli/exceptions.html">turbo_broccoli.exceptions</a></code>.</p></li>
</ul>

<h2 id="v210"><code>v2.1.0</code></h2>

<ul>
<li><p><code>sklearn</code> (de)serialization of most estimator classes, see <a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli.html#supported-types">the list of
supported
types</a>
for more details.</p></li>
<li><p>Guarded methods and guarded calls, see
<a href="https://altaris.github.io/turbo-broccoli/turbo_broccoli.html#guarded-calls">here</a>
for some basic usage.</p></li>
</ul>

<h2 id="v200"><code>v2.0.0</code></h2>

<ul>
<li><p><code>turbo-broccoli</code> now uses <a href="https://huggingface.co/docs/safetensors/index">Huggingface's
<code>safetensors</code></a> to store
<code>np.ndarray</code> and <code>tf.Tensor</code>.</p></li>
<li><p>Added support for <code>torch.Tensor</code>, also serialized using <code>safetensors</code>.</p></li>
</ul>
</div>

                        <input id="mod-turbo_broccoli-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-turbo_broccoli-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos"> 1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos"> 2</span></a><span class="sd">.. include:: ../README.md</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos"> 3</span></a><span class="sd">.. include:: ../CHANGELOG.md</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos"> 4</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos"> 5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos"> 6</span></a><span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">DistributionNotFound</span><span class="p">,</span> <span class="n">get_distribution</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos"> 7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos"> 8</span></a><span class="kn">from</span> <span class="nn">turbo_broccoli.context</span> <span class="kn">import</span> <span class="n">Context</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos"> 9</span></a><span class="kn">from</span> <span class="nn">turbo_broccoli.custom.embedded</span> <span class="kn">import</span> <span class="n">EmbeddedDict</span><span class="p">,</span> <span class="n">EmbeddedList</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">10</span></a><span class="kn">from</span> <span class="nn">turbo_broccoli.custom.external</span> <span class="kn">import</span> <span class="n">ExternalData</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">11</span></a><span class="kn">from</span> <span class="nn">turbo_broccoli.guard</span> <span class="kn">import</span> <span class="n">GuardedBlockHandler</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">12</span></a><span class="kn">from</span> <span class="nn">turbo_broccoli.native</span> <span class="kn">import</span> <span class="n">load</span><span class="p">,</span> <span class="n">save</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">13</span></a><span class="kn">from</span> <span class="nn">turbo_broccoli.parallel</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">14</span></a><span class="kn">from</span> <span class="nn">turbo_broccoli.turbo_broccoli</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">15</span></a>    <span class="n">from_json</span><span class="p">,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">16</span></a>    <span class="n">load_json</span><span class="p">,</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">17</span></a>    <span class="n">save_json</span><span class="p">,</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">18</span></a>    <span class="n">to_json</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">19</span></a><span class="p">)</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">20</span></a><span class="kn">from</span> <span class="nn">turbo_broccoli.user</span> <span class="kn">import</span> <span class="n">register_decoder</span><span class="p">,</span> <span class="n">register_encoder</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos">22</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">23</span></a>    <span class="kn">from</span> <span class="nn">turbo_broccoli.custom.secret</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">24</span></a>        <span class="n">LockedSecret</span><span class="p">,</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">25</span></a>        <span class="n">Secret</span><span class="p">,</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">26</span></a>        <span class="n">SecretDict</span><span class="p">,</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">27</span></a>        <span class="n">SecretFloat</span><span class="p">,</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">28</span></a>        <span class="n">SecretInt</span><span class="p">,</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">29</span></a>        <span class="n">SecretList</span><span class="p">,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">30</span></a>        <span class="n">SecretStr</span><span class="p">,</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">31</span></a>    <span class="p">)</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">32</span></a><span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">33</span></a>    <span class="k">pass</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">35</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">36</span></a>    <span class="n">__version__</span> <span class="o">=</span> <span class="n">get_distribution</span><span class="p">(</span><span class="s2">&quot;turbo-broccoli&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">37</span></a><span class="k">except</span> <span class="n">DistributionNotFound</span><span class="p">:</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">38</span></a>    <span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span>
</span></pre></div>


            </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>